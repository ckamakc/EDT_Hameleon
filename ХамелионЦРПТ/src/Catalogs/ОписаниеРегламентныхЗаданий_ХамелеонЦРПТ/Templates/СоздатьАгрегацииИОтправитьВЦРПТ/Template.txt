	// Вставить содержимое обработчика.
	
	ГлубинаПериода=14;
	
КаталогФайла="C:\11111";

МассивФайлов=НайтиФайлы(КаталогФайла,"*.xml",Ложь);

МассивАгрегация=Новый Массив;
Для Каждого Стр_Ф Из МассивФайлов Цикл
	
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
// Данный фрагмент построен конструктором.
// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Ссылка
	|ИЗ
	|	Документ.СозданиеНовогоШкНаКороба_ХамелеонЦРПТ КАК СозданиеНовогоШкНаКороба_ХамелеонЦРПТ
	|ГДЕ
	|	ПОДСТРОКА(СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Комментарий, 1, 1000) = &Комментарий
	|	И СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Дата >= &Дата";

НачалоДня=ТекущаяДата()-ГлубинаПериода*24*60*60;

Запрос.УстановитьПараметр("Комментарий", Стр_Ф.ПолноеИмя);
Запрос.УстановитьПараметр("Дата", НачалоДня(НачалоДня));

РезультатЗапроса = Запрос.Выполнить();

ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

Если ВыборкаДетальныеЗаписи.Следующий() Тогда
	ПродолжитЬ;
	// Вставить обработку выборки ВыборкаДетальныеЗаписи
КонецЕсли;

//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

	
		ДвоичнДанные=Новый ДвоичныеДанные(Стр_Ф.ПолноеИмя);
		Текст=ОбщийМодуль_НаСервере_ХамелеонЦРПТ.ПолучитьСтрокуИзДвоичныхДанных_Сервер(ДвоичнДанные,"UTF-8");
		Попытка
			ЧтениеXML = Новый ЧтениеXML;
			Текст=СтрЗаменить(Текст,символ(29),"");
			ЧтениеXML.УстановитьСтроку(Текст);
			Сведения = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML);
			
			
			ИНН=Сведения.Document.organisation.id_info.LP_info.LP_TIN;
			Организация=Справочники.Организации_ХамелеонЦРПТ.НайтиПоРеквизиту("ИНН",ИНН);
			Если Не ЗначениеЗаполнено(Организация) тогда
				Сообщить("Не удалось загрузить агрегации из файла, так как нет организации с данным ИНН "+ИНН);
				Продолжить;
			КонецЕсли;
			
			
			ТекущийПользователь=Справочники.Пользователи_ХамелеонЦРПТ.НайтиПоРеквизиту("Организация",Организация);
			Если Не ЗначениеЗаполнено(ТекущийПользователь) тогда
				Сообщить("Нет пользователя для подключения к организации по ИНН "+ИНН);
				Продолжить;
			КонецЕсли;
			
			ДатаД=Сведения.Document.operation_date_time;
			Если ТипЗнч(Сведения.Document.pack_content)=Тип("ОбъектXDTO") Тогда
				Стр_1=Сведения.Document.pack_content;
				
				НомерАгр=Стр_1.pack_code;
				
		СоздатьАгрегацию=Документы.СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.СоздатьДокумент();
		СоздатьАгрегацию.Статус=Перечисления.СтатусыДокументов_ХамелеонЦРПТ.ПодготовленКОтправке;
		СоздатьАгрегацию.СтатусКМ=Перечисления.СтатусыКМДляАгрегации_ХамелеонЦРПТ.КМВОбороте;
		СоздатьАгрегацию.Комментарий=Стр_Ф.ПолноеИмя;
		СоздатьАгрегацию.ТекущийПользователь=ТекущийПользователь;
		СоздатьАгрегацию.Организация=Организация;
		СоздатьАгрегацию.ТипДокумента=Перечисления.ВидДокументаУпаковок_ХамелеонЦРПТ.Формирование;
СоздатьАгрегацию.Дата=Дата(Число(Сред(ДатаД,1,4)),Число(Сред(ДатаД,6,2)),Число(Сред(ДатаД,9,2)),Число(Сред(ДатаД,12,2)),Число(Сред(ДатаД,15,2)),Число(Сред(ДатаД,18,2)));
СоздатьАгрегацию.НомерКороба=НомерАгр;
Если ТипЗнч(Стр_1.cis)<>Тип("СписокXDTO") тогда
	Стр_2=Стр_1.cis;
		Добав=СоздатьАгрегацию.Марки.Добавить();
		Добав.cis=Стр_2;
		Добав.Марка=Стр_2;
		Добав.Продукция=Справочники.Продукция_ХамелеонЦРПТ.НайтиПоРеквизиту("GTIN",Число(Сред(Стр_2,3,14)));
Иначе
	Для Каждого Стр_2 ИЗ Стр_1.cis Цикл
		Добав=СоздатьАгрегацию.Марки.Добавить();
		Добав.cis=Стр_2;
		Добав.Марка=Стр_2;
		Добав.Продукция=Справочники.Продукция_ХамелеонЦРПТ.НайтиПоРеквизиту("GTIN",Число(Сред(Стр_2,3,14)));
		
	Конеццикла;
	
	
КонецЕсли;

Если СоздатьАгрегацию.Дата<НачалоДня Тогда
	Сообщить("Документ агрегации не создан. Дата документа меньше текущей на "+Строка(ГлубинаПериода)+" дней (дата документа "+
	Строка(СоздатьАгрегацию.Дата)+", текущая дата "+Строка(ТекущаяДата()));
Иначе
	СоздатьАгрегацию.Записать();
	Сообщить("Созданы документы "+Строка(СоздатьАгрегацию));
КонецЕсли;

Докум=СоздатьАгрегацию.Ссылка;
				//Докум=ЗаполнитьДокумент(Стр_1,Организация,ТекущийПользователь,ДатаД);
			//	МассивАгрегация.Добавить(Докум);
			Иначе
				Для Каждого Стр_1 Из Сведения.Document.pack_content Цикл
			//		Докум=ЗаполнитьДокумент(Стр_1,Организация,ТекущийПользователь,ДатаД);
НомерАгр=Стр_1.pack_code;
				
		СоздатьАгрегацию=Документы.СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.СоздатьДокумент();
		СоздатьАгрегацию.Статус=Перечисления.СтатусыДокументов_ХамелеонЦРПТ.ПодготовленКОтправке;
		СоздатьАгрегацию.СтатусКМ=Перечисления.СтатусыКМДляАгрегации_ХамелеонЦРПТ.КМВОбороте;
		СоздатьАгрегацию.Комментарий=Стр_Ф.ПолноеИмя;
		СоздатьАгрегацию.ТекущийПользователь=ТекущийПользователь;
		СоздатьАгрегацию.Организация=Организация;
		СоздатьАгрегацию.ТипДокумента=Перечисления.ВидДокументаУпаковок_ХамелеонЦРПТ.Формирование;
СоздатьАгрегацию.Дата=Дата(Число(Сред(ДатаД,1,4)),Число(Сред(ДатаД,6,2)),Число(Сред(ДатаД,9,2)),Число(Сред(ДатаД,12,2)),Число(Сред(ДатаД,15,2)),Число(Сред(ДатаД,18,2)));
СоздатьАгрегацию.НомерКороба=НомерАгр;
Если ТипЗнч(Стр_1.cis)<>Тип("СписокXDTO") тогда
	Стр_2=Стр_1.cis;
		Добав=СоздатьАгрегацию.Марки.Добавить();
		Добав.cis=Стр_2;
		Добав.Марка=Стр_2;
		Добав.Продукция=Справочники.Продукция_ХамелеонЦРПТ.НайтиПоРеквизиту("GTIN",Число(Сред(Стр_2,3,14)));
Иначе
	Для Каждого Стр_2 ИЗ Стр_1.cis Цикл
		Добав=СоздатьАгрегацию.Марки.Добавить();
		Добав.cis=Стр_2;
		Добав.Марка=Стр_2;
		Добав.Продукция=Справочники.Продукция_ХамелеонЦРПТ.НайтиПоРеквизиту("GTIN",Число(Сред(Стр_2,3,14)));
		
	Конеццикла;
	
	
КонецЕсли;

Если СоздатьАгрегацию.Дата<НачалоДня Тогда
	Сообщить("Документ агрегации не создан. Дата документа меньше текущей на "+Строка(ГлубинаПериода)+" дней (дата документа "+
	Строка(СоздатьАгрегацию.Дата)+", текущая дата "+Строка(ТекущаяДата()));
Иначе
	СоздатьАгрегацию.Записать();
	Сообщить("Созданы документы "+Строка(СоздатьАгрегацию));
КонецЕсли;
					//МассивАгрегация.Добавить(Докум);
				КонецЦикла;
			КонецЕсли
		Исключение
		КонецПопытки;
		
		
	Конеццикла;
	
	
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
// Данный фрагмент построен конструктором.
// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Ссылка,
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.ТекущийПользователь
	|ИЗ
	|	Документ.СозданиеНовогоШкНаКороба_ХамелеонЦРПТ КАК СозданиеНовогоШкНаКороба_ХамелеонЦРПТ
	|ГДЕ
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыДокументов_ХамелеонЦРПТ.ПодготовленКОтправке)
	|	И НЕ СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.ПометкаУдаления
	|	И ПОДСТРОКА(СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Комментарий, 1, 1) <> """"
	|	И СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Дата >= &Дата";

Запрос.УстановитьПараметр("Дата", НачалоДня(НачалоДня));


РезультатЗапроса = Запрос.Выполнить();

ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

Пользователи_1=Новый Массив;
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	// Вставить обработку выборки ВыборкаДетальныеЗаписи
	Попытка
	ОбщийМодуль_НаСервере_ХамелеонЦРПТ.ОтправитьАгрегациюНаСервере_ХамелеонЦРПТ(ВыборкаДетальныеЗаписи.ТекущийПользователь,
		ВыборкаДетальныеЗаписи.Ссылка);
	Исключение
	КонецПопытки;
		Если Пользователи_1.Найти(ВыборкаДетальныеЗаписи.ТекущийПользователь)=Неопределено Тогда
			
			Пользователи_1.Добавить(ВыборкаДетальныеЗаписи.ТекущийПользователь);
		Конецесли;
	КонецЦикла
	;

//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
Для Каждого Стр_1 Из Пользователи_1 Цикл
	Попытка
		ОбщийМодуль_НаСервере_ХамелеонЦРПТ.ОбновитьСтатусыДокументовСерверПоПользователю(ТекущийПользователь)
	Исключение
	КонецПопытки;
КонецЦикла;



Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Ссылка КАК Ссылка,
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.ТекущийПользователь,
	|	СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Статус КАК Статус,
	|	ПОДСТРОКА(СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Комментарий, 1, 1000) КАК Комментарий
	|ИЗ
	|	Документ.СозданиеНовогоШкНаКороба_ХамелеонЦРПТ КАК СозданиеНовогоШкНаКороба_ХамелеонЦРПТ
	|ГДЕ
	|	ПОДСТРОКА(СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Комментарий, 1, 1) <> """"
	|	И СозданиеНовогоШкНаКороба_ХамелеонЦРПТ.Дата >= &Дата
	|ИТОГИ ПО
	|	Комментарий,
	|	Статус,
	|	Ссылка";

Запрос.УстановитьПараметр("Дата", НачалоДня(НачалоДня));

РезультатЗапроса = Запрос.Выполнить();

ВыборкаДетальныеЗаписи_1 = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

Пока ВыборкаДетальныеЗаписи_1.Следующий() Цикл
ВыборкаДетальныеЗаписи_2 = ВыборкаДетальныеЗаписи_1.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

УдаляемФайл=Истина;
Пока ВыборкаДетальныеЗаписи_2.Следующий() Цикл
	Если ВыборкаДетальныеЗаписи_2.Статус<>Перечисления.СтатусыДокументов_ХамелеонЦРПТ.Обработан Тогда
		УдаляемФайл=Ложь;
		Прервать;
	КонецЕсли;
КонецЦикла;	

Если УдаляемФайл Тогда
		ВыборкаДетальныеЗаписи_2.Сбросить();
		Пока ВыборкаДетальныеЗаписи_2.Следующий() Цикл
			 ВыборкаДетальныеЗаписи_3=ВыборкаДетальныеЗаписи_2.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			 Пока ВыборкаДетальныеЗаписи_3.Следующий() Цикл
				 ПолОб=ВыборкаДетальныеЗаписи_3.Ссылка.ПолучитьОбъект();
				 ПолОб.Комментарий="";
				 ПолОб.Записать();
			Конеццикла;
		Конеццикла;
		УдалитьФайлы(ВыборкаДетальныеЗаписи_1.Комментарий);
		Сообщить("Удален файл "+ВыборкаДетальныеЗаписи_1.Комментарий);
	КонецЕсли;
Конеццикла;
